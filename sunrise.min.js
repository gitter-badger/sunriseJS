!function(a){function b(a,b){for(var c=[],e=[],g=0;g<b.length;){for(c=[],e=[];!f.isFunction(b[g]);)c.push(b[g]),g++;for(;f.isFunction(b[g]);)e.push(b[g]),g++;for(var h=0;h<c.length;h++)void 0==d.controls[a][c[h]]&&(d.controls[a][c[h]]=e),d.controls[a][c[h]]=d.controls[a][c[h]].concat(e).filter(f.onlyUnique)}}var c=a.$rootScope=a.$rootScope||{},d=c.fn={};c.$scope={},c.emitDigit=[],c.gameRunning=!0;var e=c.$scope.fn={};_seal=a._seal=a._seal||function(){delete a.$rootScope,delete a._seal,delete a._unseal},_unseal=a._unseal=a._unseal||function(){a.$rootScope=c,a._seal=_seal,a._unseal=_unseal},d.focusChanged=function(a){d.emitEverywhere(a?"regainedFocus":"lostFocus")},d.tabFocusChanged=function(){f.vis()||c.canvas.blur()},d.sunrise=function(){d.onEverywhere("pause",function(){window.cancelAnimationFrame(c.animationFrame),c.gameRunning=!1,c.time.wasPaused=!0,d.controls.resetKeyPressed()}),d.onEverywhere("resume",function(){c.gameRunning=!0,c.animationFrame.call(window,d.run)}),a._seal(),d.initCanvas(),console.log("Load images"),e.loadImages(game.config.images,function(){console.log("Load sounds"),e.loadSounds(game.config.sounds,function(){void 0!==game.createComponents&&(console.log("create components"),game.createComponents(c.$scope)),console.log("Load level"),e.loadLevels(game.config.levels,function(){console.log("loadUI"),e.loadUis(game.config.uis,function(){console.log("go!"),console.log(c.ressources),game.init(c.$scope),d.initUi(),d.run()})})})})},d.run=function(){if(c.gameRunning){d.processTime(),d.clearCanvas(),d.stage.update();var a,b;for(a=b=c.keyCallbackFunctions.length;a--;)c.keyCallbackFunctions[a]();for(c.keyCallbackFunctions.splice(0,b),d.checkCollisions(),a=b=c.emitDigit.length;a--;)c.emitDigit[a]();c.emitDigit.splice(0,b),game.run(c.$scope),d.stage.draw(),c.animationFrame.call(window,d.run)}},e.fps={startTime:0,frameNumber:0,getFps:function(){this.frameNumber++;var a=(new Date).getTime(),b=(a-this.startTime)/1e3,c=Math.floor(this.frameNumber/b);return b>1&&(this.startTime=(new Date).getTime(),this.frameNumber=0),c}},d.init=function(){window.frme=c.animationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}},c.dom=document.querySelector("div[sunriseJS-app]"),void 0!=c.dom?d.init(d.run):alert("no jsengine-app found"),e.loadScript=function(a,b){var c=document.createElement("script");c.type="text/javascript",c.src=a,c.async=!0,c.onload=b,document.body.appendChild(c)},d.initPlugins=function(){for(var a={},b=game.config.plugins.length-1;b>=0&&(a[b--]="plugins/"+game.config.plugins.pop()+".js"););for(var c in a)!function(b,c){e.loadScript(c,function(){delete a[b],0===Object.keys(a).length&&d.emit("all_plugins_loaded")})}(c,a[c])},function(){var a={};e.components={},e.components.add=function(b,c){if(void 0!==a[b])throw new Error('Component of type "'+b+'" already exist.');a[b]=c},e.components.create=function(b,c){if(void 0===a[b])throw new Error('No component of type "'+b+'" exists.');return a[b](c)}}(),c.events={},c.$scope.events={},d.emit=function(a,b){void 0!=c.events[a]&&c.events[a].forEach(function(a){a(b)})},d.emitEverywhere=function(a,b){d.emit(a,b),e.emit(a,b)},d.onEverywhere=function(a,b){d.on(a,b),e.on(a,b)},d.on=function(a,b){void 0!=c.events[a]?c.events[a].push(b):(c.events[a]=[],c.events[a].push(b))},e.emit=function(a,b){void 0!=c.$scope.events[a]&&c.$scope.events[a].forEach(function(a){a(b)})},e.on=function(a,b){void 0!=c.$scope.events[a]?c.$scope.events[a].push(b):(c.$scope.events[a]=[],c.$scope.events[a].push(b))},e.controls={},c.keyCallbackFunctions=[],d.controls={keys:{},keycallbacksDown:{},keycallbacksUp:{},keysPressed:{}},d.controls.init=function(){d.controls.generateKeys()},e.controls.onKeyDown=function(){b("keycallbacksDown",arguments)},e.controls.onKeyUp=function(){b("keycallbacksUp",arguments)},d.handleKeyDown=function(a){if(!d.controls.keysPressed[a.keyCode]){if(void 0!=d.controls.keycallbacksDown[d.controls.keys.names[a.keyCode]])for(var b=0;b<d.controls.keycallbacksDown[d.controls.keys.names[a.keyCode]].length;++b)c.keyCallbackFunctions.push(d.controls.keycallbacksDown[d.controls.keys.names[a.keyCode]][b]);d.controls.keysPressed[a.keyCode]=!0}},d.handleKeyUp=function(a){if(void 0!=d.controls.keycallbacksUp[d.controls.keys.names[a.keyCode]])for(var b=0;b<d.controls.keycallbacksUp[d.controls.keys.names[a.keyCode]].length;++b)c.keyCallbackFunctions.push(d.controls.keycallbacksUp[d.controls.keys.names[a.keyCode]][b]);d.controls.keysPressed[a.keyCode]=!1},d.on("canvas-fully-loaded",function(){c.canvas.addEventListener("keydown",d.handleKeyDown),c.canvas.addEventListener("keyup",d.handleKeyUp)}),e.controls.isKeyPressed=function(){var a=!0;for(i=-1;++i<arguments.length&&a;)a=d.controls.keysPressed[d.controls.keys.codes[arguments[i]]]||d.controls.keysPressed[arguments[i]];return a},d.controls.resetKeyPressed=function(){for(var a in d.controls.keysPressed)d.controls.keysPressed[a]=!1},d.controls.generateKeys=function(){var a={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,"pause/break":19,"caps lock":20,esc:27,space:32,"page up":33,"page down":34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,"delete":46,windows:91,"right click":93,"numpad *":106,"numpad +":107,"numpad -":109,"numpad .":110,"numpad /":111,"num lock":144,"scroll lock":145,"my computer":182,"my calculator":183,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222},b={ctl:17,pause:19,"break":19,caps:20,escape:27,pgup:33,pgdn:33,ins:45,del:46};for(c=97;123>c;c++)a[String.fromCharCode(c)]=c-32;for(var c=48;58>c;c++)a[c-48]=c;for(c=1;13>c;c++)a["f"+c]=c+111;for(c=0;10>c;c++)a["numpad "+c]=c+96;for(var e in b)a[e]=b[e];var f={};for(c in a)f[a[c]]=c;d.controls.keys.codes=a,d.controls.keys.names=f},d.controls.init(),c.fn.initCanvas=function(){var a=game.config.screenWidth,b=game.config.screenHeight,e=document.createElement("canvas");e.id="sunriseJS-screen",e.width=a,e.height=b,e.tabIndex="1",c.dom.appendChild(e),c.canvas=e,c.canvas.context=e.getContext("2d"),e.focus(),c.canvas.addEventListener("blur",function(){d.focusChanged(!1)}),c.canvas.addEventListener("focus",function(){d.focusChanged(!0)}),d.emit("canvas-fully-loaded")},c.fn.clearCanvas=function(){c.canvas.context.save(),c.canvas.context.setTransform(1,0,0,1,0,0),c.canvas.context.clearRect(0,0,game.config.screenWidth,game.config.screenHeight),c.canvas.context.restore()};var f=c.$scope.util={};Object.prototype.watch||Object.defineProperty(Object.prototype,"watch",{self:this,enumerable:!1,configurable:!0,writable:!1,value:function(a,b){var c=this[a],d=c,e=function(){return d},f=function(e){return c=d,d=b.call(this,a,c,e)};delete this[a]&&Object.defineProperty(this,a,{get:e,set:f,enumerable:!0,configurable:!0})}}),Object.prototype.unwatch||Object.defineProperty(Object.prototype,"unwatch",{enumerable:!1,configurable:!0,writable:!1,value:function(a){var b=this[a];delete this[a],this[a]=b}}),f.vis=function(){var a,b,c={hidden:"visibilitychange",webkitHidden:"webkitvisibilitychange",mozHidden:"mozvisibilitychange",msHidden:"msvisibilitychange"};for(a in c)if(a in document){b=c[a];break}return document.addEventListener(b,d.tabFocusChanged),function(c){return c&&document.addEventListener(b,c),!document[a]}}(),f.partial=function(a,b){var c=Array.prototype.slice.call(arguments,2);return function(){var d=c.concat(Array.prototype.slice.call(a,arguments));return b.apply(a,d)}},f.ajax=function(a,b,c){var d;d=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),d.onreadystatechange=function(){4==d.readyState&&200==d.status&&b(d.responseText)},d.open("GET",a+"?nocache="+(new Date).getTime(),!0),c?(d.setRequestHeader("Content-type","application/x-www-form-urlencoded"),d.setHeader("Pragma","no-cache"),d.setHeader("Cache-Control","no-cache"),d.setDateHeader("Expires",0),d.send(c)):d.send()};var g=function(a,b,c){if("object"==typeof a){if(!a instanceof f.Vec2)throw new Error("Can't use "+a+"as Vec2");c(a)}else{if(void 0===b||"undefined"==typeof b)throw new Error("Excpected value for y");c(new f.Vec2(a,b))}};f.isFunction=function(a){var b={};return a&&"[object Function]"===b.toString.call(a)},f.Vec2=function(a,b){if("object"==typeof a){if(!a instanceof f.Vec2)throw new Error("Can't use "+a+"as Vec2");this.x=a.x,this.y=a.y}else this.x=a,this.y=b},f.Vec2.prototype.add=function(a,b){var c=this;g(a,b,function(a){c.x+=a.x,c.y+=a.y})},f.Vec2.add=function(a,b){return new f.Vec2(a.x+b.x,a.y+b.y)},f.Vec2.prototype.subtract=function(a,b){var c=this;g(a,b,function(a){c.x-=a.x,c.y-=a.y})},f.Vec2.subtract=function(a,b){return new f.Vec2(a.x-b.x,a.y-b.y)},f.Vec2.prototype.sub=f.Vec2.prototype.subtract,f.Vec2.sub=f.Vec2.subtract,f.Vec2.prototype.multiply=function(a){this.x*=a,this.y*=a},f.Vec2.multiply=function(a,b){var c=new f.Vec2(a);return c.multiply(b),c},f.Vec2.prototype.mul=f.Vec2.prototype.multiply,f.Vec2.mul=f.Vec2.multiply,f.Vec2.prototype.divide=function(a){this.multiply(1/a)},f.Vec2.divide=function(a,b){var c=new f.Vec2(a);return c.divide(b),c},f.Vec2.dot=function(a,b){return a.x*b.x+a.y*b.y},f.Vec2.prototype.div=f.Vec2.prototype.divide,f.Vec2.div=f.Vec2.divide,f.size=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c},f.guid=function(){function a(a){var b=(Math.random().toString(16)+"000000000").substr(2,8);return a?"-"+b.substr(0,4)+"-"+b.substr(4,4):b}return a()+a(!0)+a(!0)+a()},f.onlyUnique=function(a,b,c){return c.indexOf(a)===b},f.getClass=function(a){if(a&&"object"==typeof a&&"[object Array]"!==Object.prototype.toString.call(a)&&a.constructor&&a!==this.window){var b=a.constructor.toString().match(/function\s*(\w+)/);if(b&&2===b.length)return b[1]}return!1},f.inArray=function(a,b,c){var d;if(b){if(b.indexOf)return b.indexOf.call(b,a,c);for(d=b.length,c=c?0>c?Math.max(0,d+c):c:0;d>c;c++)if(c in b&&b[c]===a)return c}return-1},c.ressources={images:{},sprites:{},sounds:{},levels:{},ui:{}},e.loadImages=function(a,b){var d={},e=0;for(key in a)d[key]=a[key],e++;if(0===e)return void b();for(title in d)!function(a,e){var f,g;if("object"==typeof e){if(void 0===e.source)throw new Error('No attribute "source" found in image '+title);f=e.source,g=e,g.name=title}else f=e,g={},g.name=title;if(void 0!==c.ressources.images[a])throw new Error("Imageressource with name "+a+" already exists");var h=new Image;h.onload=function(){delete d[a],c.ressources.images[a]=this;var e=!0;for(index in d){e=!1;break}e&&b()},h.src=f}(title,d[title])},e.loadUis=function(a,b){var d={},e=0;for(key in a)d[key]=a[key],e++;if(0===e)return void b();for(key in d)f.ajax(d[key],function(a){c.ressources.ui=JSON.parse(a),delete d[key];var e=!0;for(index in d){e=!1;break}e&&b()})},e.loadLevels=function(a,b){var d={},e=0;for(key in a)d[key]=a[key],e++;if(0===e)return void b();for(key in d)f.ajax(d[key],function(a){c.ressources.levels[key]=JSON.parse(a),delete d[key];var e=!0;for(index in d){e=!1;break}e&&b()})},e.loadSounds=function(a,b){var d={},e=0;for(key in a)d[key]=a[key],e++;if(0===e)return void b();for(title in d)!function(a,e){function f(e){if(d[a]){delete d[a],c.ressources.sounds[a]=e;var f=!0;for(index in d){f=!1;break}f&&b()}}if(void 0===e.file)throw new Error('Please provide filename for sound "'+a+'".');if(void 0!==c.ressources.sounds[a])throw new Error("Soundsressource with name "+a+" already exists");var g=new Audio;g.preload="true",e.loop===!0&&addEventListener("timeupdate",function(){var a=.5;this.currentTime>this.duration-a&&(this.currentTime=0,this.play())},!1),g.addEventListener("loadeddata",function(){f(this)},!1),g.onerror=function(){throw new Error('Error while loading sound "'+a+'"')},g.src=e.file,g.load(),setTimeout(function h(){isNaN(g.duration)?setTimeout(h,100):f(g)},100)}(title,d[title])},e.CoreObject=function(){function a(){}return a.extend=function(a){a.prototype=Object.create(this.prototype),a.prototype.constructor=a,a.prototype.super_=this.prototype,a.extend=this.extend},a}(),e.playSound=function(a){if(void 0===c.ressources.sounds[a])throw new Error('No sound with name "'+a+'" found.');c.ressources.sounds[a].play()},e.pauseSound=function(a){if(void 0===c.ressources.sounds[a])throw new Error('No sound with name "'+a+'" found.');c.ressources.sounds[a].pause()},e.isSoundPlaying=function(a){if(void 0===c.ressources.sounds[a])throw new Error('No sound with name "'+a+'" found.');return!c.ressources.sounds[a].paused},e.Sprite=function(){var a,b,d,f;return Sprite=function(e){if(void 0===game.config.images[e])throw new Error('No image with name "'+e+'" found');var g=game.config.images[e],h=[];(void 0!==g.tileWidth||void 0!==g.tileHeight||void 0!==g.animations)&&(h.push("tileWidth"),h.push("tileHeight")),h.forEach(function(a){if(void 0===g[a]||""===g[a])throw new Error('No element "'+a+'" specified in data')});var i=c.ressources.images[e];void 0===g.tileWidth&&(g.tileWidth=i.width,g.tileHeight=i.height),void 0===g.animations&&(g.animations={}),void 0===g.animations.default&&(g.animations.default=[0]),a=i,b=g.tileWidth,d=g.tileHeight,this.rotation=0,this.alpha=1,f=g.animations,this.anchor={x:0,y:0},this.context=c.canvas.context;for(anim in f){this.currentAnimation=f[anim];break}this.currentFrame=0,this.lastDrawTime=Date.now(),this.frameDuration=60,this.cols=Math.floor(i.width/b),this.rows=Math.floor(i.height/d)},e.CoreObject.extend(Sprite),Sprite.prototype.draw=function(c,e,f,g){if(c-=this.anchor.x,e-=this.anchor.y,1!==this.alpha){var h=this.context.globalAlpha;this.context.globalAlpha=this.alpha}0!==this.rotation&&(this.context.save(),this.context.translate(c,e),this.context.rotate(this.rotation),this.context.translate(-c,-e));var i=f||b,j=g||d,k=this.currentAnimation[this.currentFrame],l=k%this.cols*b,m=Math.floor(k/this.cols)*d;this.context.drawImage(a,l,m,b,d,c,e,i,j);var n=Date.now(),o=n-this.lastDrawTime;o>=this.frameDuration&&(this.currentFrame++,this.currentFrame>=this.currentAnimation.length&&(this.currentFrame=0),this.lastDrawTime=n),1!==this.alpha&&(this.context.globalAlpha=h),0!==this.rotation&&this.context.restore()},Sprite.prototype.setAnimation=function(a,b){if(void 0===f[a])throw new Error("No animation with name "+a+" found");(this.currentAnimation!=f[a]||void 0!==b)&&(this.currentAnimation=f[a],this.currentFrame=b||0)},Sprite.prototype.setRotationDeg=function(a){this.setRotationRad(a*Math.PI/180)},Sprite.prototype.setRotationRad=function(a){a%=2*Math.PI,this.rotation=a},Sprite.prototype.setAlpha=function(a){a=0>a?0:a,a=a>1?1:a,this.alpha=a},Sprite.prototype.setAnchor=function(a,b){"object"==typeof a&&"undefined"!=typeof a.x&&"undefined"!=typeof a.y?(this.anchor.x=a.x,this.anchor.y=a.y):(this.anchor.x=a,this.anchor.y=b)},Sprite}(),e.Entity=function(){function a(a,b,c,d,g,h){this.components={},this.data={},this.id=f.guid(),this.x=a,this.y=b,this.width=c,this.height=d,this.anchor=g,this.config=h;for(var i in h){var j=e.components.create(i,h[i]);this.components[i]=j,this.data[i]={},j.receive("setEntity",{entity:this,data:this.data[i]})}}return e.CoreObject.extend(a),a.prototype.emit=function(a,b){for(var c in this.components)this.components[c].receive(a,b)},a.prototype.getComponentData=function(a,b){if(void 0===this.components[a])throw console.warn("Error in Entity "+this),new Error('No component "'+a+'" found in entity.');return this.data[a][b]},a.prototype.clone=function(a,b,c,d){return a=void 0===a?this.x:a,b=void 0===b?this.y:b,c=void 0===c?this.width:c,d=void 0===d?this.height:d,new e.Entity(a,b,c,d,{x:this.anchor.x,y:this.anchor.y},this.config)},a}();var h=[];e.stage=d.stage={};var j={},k={x:0,y:0},l={tiles:function(a,b,d){return tilesetInfo=game.config.images[a.tileset],tileset=c.ressources.images[a.tileset],tileWidth=tilesetInfo.tileWidth,tileHeight=tilesetInfo.tileHeight,canvas=document.createElement("canvas"),context=canvas.getContext("2d"),canvas.width=b,canvas.height=d,a.tiles.forEach(function(b){var d=b[2]*tileWidth,e=b[3]*tileHeight,f=b[0]*tileWidth,g=b[1]*tileHeight;if(context.drawImage(tileset,d,e,tileWidth,tileHeight,f,g,tileWidth,tileHeight),void 0!==a.group){var h=new c.$scope.fn.Entity(f,g,tileWidth,tileHeight,{x:0,y:0},{CollisionBody:{},Physics:{mass:0,forces:{}}});c.$scope.fn.addToGroup(h,a.group)}}),{buffer:canvas}},image:function(a,b,d){var e=document.createElement("canvas"),f=e.getContext("2d"),g=c.ressources.images[a.image];e.width=b,e.height=d;var h,i;switch(a["size-x"]){case"stretch":h=b;break;case"loop":case"original":case void 0:h=g.width;break;default:throw new Error('Unknow size-x: "'+a["size-x"]+'".')}switch(a["size-y"]){case"stretch":i=d;break;case"loop":case"original":case void 0:i=g.height;break;default:throw new Error('Unknow size-x: "'+a["size-x"]+'".')}var j=0,k=0;do{do f.drawImage(g,0,0,g.width,g.height,j,k,h,i),j+=h;while(b>j&&"original"!==a["size-x"]);k+=i,j=0}while(d>k&&"original"!==a["size-y"]);return{buffer:e,scrollX:a["scroll-x"],scrollY:a["scroll-y"]}}};e.stage.setLevel=function(a){if(void 0===c.ressources.levels[a])throw new Error('No level with name "'+a+'" found.');var b=c.ressources.levels[a],f=b.width,g=b.height;b.layer.forEach(function(a){if(void 0===l[a.type])throw new Error('Invalid layer type "'+a.type+'"');var b=l[a.type](a,f,g);if(void 0===b)throw new Error("Error while creating level");b.x=a.x||0,b.y=a.y||0,b.z=a.z||0,h.push(b)}),h.sort(function(a,b){return a.z>b.z?-1:a.z<b.z?1:0});var i="";if("object"==typeof b.background){var j=b.background;void 0!==j.color?i=j.color:void 0!==j.from&&void 0!==j.to&&(i="linear-gradient(to bottom, "+j.from+" 0%,"+j.to+" 100%)")}c.canvas.style.background=i;for(key in game.config.entityTypes)game.config.entityTypes[key].groups.forEach(function(a){e.defineEmptyGroup(a)});var k=game.config.entityTypes;b.entities.forEach(function(a){if(console.log("data:",a),void 0===k[a.type])throw new Error("Can't created Entity. Unknow type \""+a.type+'".');var b={},d=k[a.type];for(key in d.components)b[key]=d.components[key],void 0!==a.components&&void 0!==a.components[key]&&(b[key]=a.components[key]);var f={x:d.anchor.x,y:d.anchor.y},g=new e.Entity(a.x,a.y,d.width,d.height,f,b);d.groups.forEach(function(a){e.addToGroup(g,a)}),void 0!==a.name&&(c.$scope[a.name]=g),console.log("created:"+a.type,g)}),d.emit("levelLoaded",{name:a,width:f,height:g})},e.stage.setFocus=function(a,b,c){a instanceof e.Entity?(j.entity=a,j.xoffset=b||0,j.yoffset=c||0):(j.x=a,j.y=b,j.entity=void 0)},function(){e.stage.update=function(){c.groups.groups.toRender.forEach(function(a){a.emit("tick",{delta:c.time.delta})})}}(),e.stage.draw=function(){function a(a){var b=j.centerX-j.x*(a.scrollX||1)+a.x,d=j.centerY-j.y*(a.scrollY||1)+a.y;c.canvas.context.drawImage(a.buffer,b,d)}void 0===j.x&&(j.x=c.canvas.width/2,j.y=c.canvas.height/2,j.centerX=c.canvas.width/2,j.centerY=c.canvas.height/2),void 0!==j.entity&&(j.x=j.entity.x+j.xoffset,j.y=j.entity.y+j.yoffset);for(var b=0;b<h.length&&h[b].z>=0;b++)a(h[b]);for(k.x=j.centerX-j.x,k.y=j.centerY-j.y,c.groups.groups.toRender.forEach(function(a){a.emit("draw",{offsetX:k.x,offsetY:k.y})});b<h.length;b++)a(h[b])},function(){var b={};b.addEntityToGroup=function(a,b){void 0===c.groups.groups[b]&&(c.groups.groups[b]=[]),f.inArray(a,c.groups.groups[b])&&c.groups.groups[b].push(a)},b.addEntitiesToGroup=function(a,b){void 0===c.groups.groups[b]&&(c.groups.groups[b]=[]);for(var d=0;d<a.length;++d)-1===f.inArray(a[d],c.groups.groups[b])&&c.groups.groups[b].push(a[d])},b.addPairToCollingObjects=function(a){c.groups.collidingObjects.push([a[0],a[1]])},b.deleteFromCollidingObjects=function(a){for(var b=0;b<c.groups.collidingObjects.length;++b)(c.groups.collidingObjects[b][0].id==a.id||c.groups.collidingObjects[b][1].id==a.id)&&c.groups.collidingObjects.splice(b,1)},b.generateCollidingObjects=function(){c.groups.collidingObjects=[];for(var a=c.groups.collidingGroups.length;a--;)for(var d=c.groups.collidingGroups[a][0],e=c.groups.collidingGroups[a][1],f=0;f<d.length;++f)for(var g=0;g<e.length;++g)b.addPairToCollingObjects([d[f],e[g]])},c.groups={groups:{toRender:[]},collidingGroups:[]},e.defineEmptyGroup=function(a){c.groups.groups[a]=[]},e.addToGroup=function(a,c){if(a instanceof Array){for(var d=a.length;d--;)if(!(a[d]instanceof e.Entity))throw new Error("Object is not an Entity.");b.addEntitiesToGroup(a,c)}else{if(!(a instanceof e.Entity))throw new Error("Object is not an Entity.");b.addEntityToGroup(a,c)}},e.defineCollidingGroups=function(a,b,d){var e=c.groups.groups[a],f=c.groups.groups[b];if(void 0===e||void 0===f)throw new Error("One of the given groups is undefined!",a,b);c.groups.collidingGroups.push([e,f,d])},e.deleteCollidingGroups=function(a,b){for(var d=c.groups.collidingGroups.length;d--;)c.groups.collidingGroups[d][0]===c.groups.groups[collide]&&c.groups.collidingGroups[d][1]===c.groups[groups][b]&&c.groups.collidingGroups.splice(d,1)},e.removeEntityFromGroup=function(a,b){if(!(a instanceof e.Entity))throw new Error("Given object is not an Entity",a);var d=c.groups.groups[b].indexOf(a);-1!=d&&c.groups.groups[b].splice(d,1)},e.removeEntityFromAllGroups=function(a){if(!(a instanceof e.Entity))throw new Error("Given object is not an Entity",a);var b=e.getGroupsByEntity(a);if(b)for(var c=b.length;c--;)e.removeEntityFromGroup(a,b[c])},e.getGroupsByEntity=function(a){if(!(a instanceof e.Entity))throw new Error("Given object is not an Entity",a);var b=[];for(var d in c.groups.groups)if(c.groups.groups.hasOwnProperty(d)){var f=c.groups.groups[d];for(var g in f)f.hasOwnProperty(g)&&a.id==f[g].id&&b.push(d)}return b},e.getGroups=function(){return c.groups.groups},a.getGroups=function(){return c.groups}}();var m=window.Quadtree=e.Quadtree=function(a,b,c,d,e,f,g){this.maxLevels=f||5,this.maxEntities=g||10,this.level=a,this.bounds={x:b,y:c,width:d,height:e},this.center={x:b+d/2,y:c+e/2},this.nodes=[],this.entities=[]};m.prototype.clear=function(){this.entities=[];for(var a=this.nodes.length;a--;)"undefined"!=typeof this.nodes[a]&&this.nodes[a].clear();this.nodes=[]},m.prototype.getNodeIndex=function(a){var b=a.x,c=a.y,d=this.center.x,e=this.center.y,f=d>b&&b+a.width<d,g=b>d,h=e>c&&c+a.height<e,i=c>e;if(f){if(h)return 1;if(i)return 2}else if(g){if(h)return 0;if(i)return 3}return-1},m.prototype.split=function(){var a=this.bounds.x,b=this.bounds.y,c=this.bounds.width/2,d=this.bounds.height/2,e=this.level+1;this.nodes[0]=new m(e,a+c,b,c,d),this.nodes[1]=new m(e,a,b,c,d),this.nodes[2]=new m(e,a,b+d,c,d),this.nodes[3]=new m(e,a+c,b+d,c,d)},m.prototype.insert=function(a){if(0!==this.nodes.length){var b=this.getNodeIndex(a);if(-1!==b)return void this.nodes[b].insert(a)}if(this.entities.push(a),this.entities.length>this.maxEntities&&this.level<this.maxLevels){0===this.nodes.length&&this.split();for(var c=this.nodes.length;c--;){var b=this.getNodeIndex(this.entities[c]);-1!==b&&this.nodes[b].insert(this.entities.pop())}}},m.prototype.getPossibleCollisions=function(a){var b=[],c=this.getNodeIndex(a);return-1!==c&&0!==this.nodes.length&&(b=b.concat(this.nodes[c].getPossibleCollisions(a))),b=b.concat(this.entities)},function(){var a=0,b=0,e={rectangle:{rectangle:function(d,e){0==a&&(b=c.time.actual),a++,c.time.actual-b>5e3&&(console.log("rectangle",a),a=0);var f={},g={x:d.x-e.x,y:d.y-e.y,ax:Math.abs(d.x-e.x),ay:Math.abs(d.y-e.y)},h=d.x<e.x?g.ax+e.width:g.ax+d.width,i=d.width+e.width-h;if(i>0){var j=d.y<e.y?g.ay+e.height:g.ay+d.height,k=d.height+e.height-j;if(k>0)return k>i?(f.normal=g.x<0?{x:1,y:0}:{x:-1,y:0},f.penetration=i):(f.normal=g.y<0?{x:0,y:1}:{x:0,y:-1},f.penetration=k),f}return!1},circle:function(){return!1},pixel:function(){return!1}},circle:{rectangle:function(){e.rectangle.circle(second,first)},circle:function(a,b){var c=Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2),d=Math.pow(a.r+b.r,2);return d>=c},pixel:function(){return!1}},pixel:{rectangle:function(){e.rectangle.pixel(second,first)},circle:function(){e.circle.pixel(second,first)},pixel:function(){return!1}}};d.colliderTesters=e,d.checkCollisions=function(){var a,b,d,g=c.groups.collidingGroups;for(i=g.length-1;i>=0;--i){a=g[i][0],b=g[i][1],d=g[i][2];for(var h=a.length;h--;)for(var j=b.length;j--;){var k=a[h],l=b[j],m=k.x-k.anchor.x,n=k.width,o=l.x-l.anchor.x,p=l.width;if(o>=m&&m+n>=o||m>=o&&o+p>=m){var q=k.y-k.anchor.y,r=k.height,s=l.y-l.anchor.y,t=l.height;if(s>=q&&q+r>=s||q>=s&&s+t>=q){var u=k.getComponentData("CollisionBody","bounds"),v=l.getComponentData("CollisionBody","bounds"),w=k.getComponentData("CollisionBody","colliderType"),x=l.getComponentData("CollisionBody","colliderType");u.x+=k.x,u.y+=k.y,v.x+=l.x,v.y+=l.y;var y=e[w][x](u,v);if(u.x-=k.x,u.y-=k.y,v.x-=l.x,v.y-=l.y,y!==!1){var z={normal:{x:-y.normal.x,y:-y.normal.y},penetration:y.penetration};c.emitDigit.push(f.partial(k,k.emit,"collision",{other:l,collision:y})),c.emitDigit.push(f.partial(l,l.emit,"collision",{other:k,collision:z}))}}}}}}}(),e.Component=function(){return Component=function(){var a=this;this.receiver={},this.on("setEntity",function(b){a.entity=b.entity,a.data=b.data,a.init()})},e.CoreObject.extend(Component),Component.prototype.init=function(){},Component.prototype.on=function(a,b,c){if(void 0!==this.receiver[a]&&!c)throw new Error('Already defined a callback for "'+a+'"');this.receiver[a]=b},Component.prototype.receive=function(a,b){"undefined"!=typeof this.receiver[a]&&this.receiver[a](b)},Component}(),e.Renderer=function(){return Renderer=function(a){e.Component.call(this),this.config=a},e.Component.extend(Renderer),Renderer.prototype.init=function(){var a=this,b=this.config,d=b.image;if(void 0===game.config.images[d])throw new Error('No image with name "'+d+'" found');var e=game.config.images[d],f=b||{},g=[];if((void 0!==e.tileWidth||void 0!==e.tileHeight||void 0!==e.animations)&&(g.push("tileWidth"),g.push("tileHeight")),g.forEach(function(a){if(void 0===e[a]||""===e[a])throw new Error('No element "'+a+'" specified in data')}),this.image=c.ressources.images[d],void 0===e.tileWidth&&(e.tileWidth=this.image.width,e.tileHeight=this.image.height),void 0===e.animations&&(e.animations={}),void 0===e.animations.default&&(e.animations.default=[0]),this.setAnimation=function(a){var b=this.animations[a];if(b instanceof Array)0===this.currentAnimation.out.length?(this.currentAnimation={"in":[],out:[],loop:b},this.currentFrameNumber=0,this.animationType="in",this.currentAnimation.name=a):this.nextAnimation={"in":[],out:[],loop:b,name:a};else{if(void 0===b.loop||0===b.loop.length)throw new Error('Please provide at least a "loop" animation with 1 frame.');this.nextAnimation={},this.nextAnimation["in"]=b["in"]||[],this.nextAnimation.loop=b.loop,this.nextAnimation.out=b.out||[],this.nextAnimation.name=a}},this.nextFrame=function(){for(this.currentFrameNumber++;this.currentFrameNumber>=this.currentAnimation[this.animationType].length;)switch(this.animationType){case"in":this.currentFrameNumber=0,this.animationType="loop";break;case"loop":this.currentFrameNumber=0,void 0!==this.nextAnimation&&(this.animationType="out");break;case"out":this.currentFrameNumber=0,this.currentAnimation=this.nextAnimation,this.nextAnimation=void 0,this.animationType="in"}this.currentFrame=this.currentAnimation[this.animationType][this.currentFrameNumber]},this.width=e.tileWidth,this.height=e.tileHeight,this.rotation=f.rotation||0,this.alpha=void 0===f.alpha?1:f.alpha,this.animations=e.animations,this.anchor=a.entity.anchor||{x:0,y:0},this.context=c.canvas.context,this.currentFrameNumber=0,this.currentAnimation={"in":[],loop:[],out:[],name:""},this.animationType="in",this.lastDrawTime=c.time.actual,this.frameDuration=60,void 0===f.animation||void 0===this.animations[f.animation])for(anim in this.animations){this.setAnimation(anim);break}else this.setAnimation(f.animation);this.cols=Math.floor(a.image.width/a.width),this.rows=Math.floor(a.image.height/a.height),this.on("draw",function(b){var d=a.entity.x+b.offsetX,e=a.entity.y+b.offsetY,f=d-a.anchor.x,g=e-a.anchor.y,h=1;1!==a.alpha&&(h=a.context.globalAlpha,a.context.globalAlpha=a.alpha),0!==a.rotation&&(a.context.save(),a.context.translate(d,e),a.context.rotate(a.rotation),a.context.translate(-d,-e));var i=a.entity.width||a.width,j=a.entity.height||a.height,k=a.currentFrame,l=k%a.cols*a.width,m=Math.floor(k/a.cols)*a.height;a.context.drawImage(a.image,l,m,a.width,a.height,f,g,i,j);var n=c.time.actual-a.lastDrawTime;if(n>=a.frameDuration&&(a.nextFrame(),a.lastDrawTime=c.time.actual),0!==a.rotation&&a.context.restore(),1!==a.alpha&&(a.context.globalAlpha=h),window.debug){var o=a.entity.getComponentData("CollisionBody","bounds");a.context.strokeStyle="#FF0000",a.context.strokeRect(f,g,a.entity.width,a.entity.height),void 0!==o&&(a.context.strokeStyle="#0000FF",a.context.strokeRect(a.entity.x+b.offsetX+o.x,a.entity.y+b.offsetY+o.y,o.width,o.height)),a.context.strokeStyle="#00FF00",a.context.strokeRect(f+a.anchor.x,g+a.anchor.y,1,1)}}),this.on("rotate",function(b){var c=0;c=void 0!==b.degree?b.degree*Math.PI/180:b.radian,b.isRelative?a.rotation+=c:a.rotation=c,a.rotation%=2*Math.PI}),this.on("changeAnimation",function(b){if(void 0===a.animations[b.animation])throw new Error("No animation with name "+b.animation+" found");(!(a.currentAnimation.name===b.animation||a.nextAnimation&&a.nextAnimation.name===b.animation)||b.restart)&&a.setAnimation(b.animation)}),this.on("changeOpacity",function(b){a.alpha=b.opacity||0,a.alpha=a.alpha>1?1:a.alpha<0?0:a.alpha}),this.data.anchor=this.anchor},Renderer}(),e.components.add("Renderer",function(a){return new e.Renderer(a)}),e.StateMachine=function(){return StateMachine=function(a){e.Component.call(this),this.config=a},e.Component.extend(StateMachine),StateMachine.prototype.init=function(){var a=this;if(this.states=this.config.states||{},void 0===this.config.default)throw console.warn("Error in StateMachine "+this),new Error("Can't find state \""+this.config.default+'"');this.data.currentState=this.config.default,this.data.currentStateObj=this.states[this.config.default].values,this.on("setStates",function(b){for(var c={},d=b.length;d--;){if(void 0===a.states[b[d]])throw new Error("no State with name: "+name);if(void 0!==a.states[b[d]].events)for(name in a.states[b[d]].events)a.entity.emit(name,a.states[b[d]].events[name]);for(var e in a.states[b[d]].values)a.states[b[d]].values.hasOwnProperty(e)&&(c[e]=a.states[b[d]].values[e])}a.data.currentState=b,a.data.currentStateObj=c}),this.on("addState",function(b){if(void 0===b.name)throw console.warn("Error in statemachine "+a),new Error("No name provided for new state");if(void 0===b.state)throw console.warn("Error in statemachine "+a),new Error("No state provided to add");if(void 0!=a.states[b.name])throw console.warn("Error in statemachine "+a),new Error("State: "+b.name+" already exists");a.states[b.name]=b.state})},StateMachine}(),e.components.add("StateMachine",function(a){return new e.StateMachine(a)}),c.time=c.$scope.time={delta:0,actual:Date.now(),wasPaused:!1},d.processTime=function(){c.time.wasPaused?(c.time.actual=Date.now(),c.time.wasPaused=!1):(c.time.delta=Date.now()-c.time.actual,c.time.actual=Date.now())},function(){function a(){var a=c.ressources.ui;for(var e in a)for(var g in a[e])if("variables"==g)for(var h in a[e][g])f.variables[h]=a[e][g][h],b[h]=a[e][g][h],d.varChanged(h,a[e][g][h],a[e][g][h]),f.variables.watch(h,function(a,b,c){return d.varChanged(a,b,c),c}),b.watch(h,function(a,b,c){return d.varChanged(a,b,c),c})}var b=c.$scope.gameVariables={};d.initUi=function(){c.ui=document.querySelector("div[sunriseJS-ui]"),a()};var f=window.ui=c.ui={variables:{}};d.varChanged=function(a,b,c){var d=document.querySelector("div[sr-ui-"+a+"]");if(d)switch(d.getAttribute("sr-ui-type")){case"variable":d.innerHTML=d.getAttribute("sr-ui-"+a)+c;break;case"array":console.log(a,b,c),console.log(d)}},e.showUi=function(){},e.hideUi=function(){}}(),d.on("all_plugins_loaded",d.sunrise),d.initPlugins()}($sr=window.$sr=window.$sr||{});
//# sourceMappingURL=sunrise.min.js.map